{
    "contents" : "\n\n\nlib <- c(\"foreign\", \"lme4\", \"car\", \"descr\", \"effects\", \"xtable\",  \"sas7bdat\", \"texreg\", \"lmtest\", \"Hmisc\", \"ggplot2\")\nrequire(lib)\nlapply(lib, require, character.only=T)\n\n## re = object of class ranef.mer\nggCaterpillar <- function(re, QQ=TRUE, likeDotplot=TRUE) {\n  require(ggplot2)\n  f <- function(x) {\n    pv   <- attr(x, \"postVar\")\n    cols <- 1:(dim(pv)[1])\n    se   <- unlist(lapply(cols, function(i) sqrt(pv[i, i, ])))\n    ord  <- unlist(lapply(x, order)) + rep((0:(ncol(x) - 1)) * nrow(x), each=nrow(x))\n    pDf  <- data.frame(y=unlist(x)[ord],\n                       ci=1.96*se[ord],\n                       nQQ=rep(qnorm(ppoints(nrow(x))), ncol(x)),\n                       ID=factor(rep(rownames(x), ncol(x))[ord], levels=rownames(x)[ord]),\n                       ind=gl(ncol(x), nrow(x), labels=names(x)))\n    \n    if(QQ) {  ## normal QQ-plot\n      p <- ggplot(pDf, aes(nQQ, y))\n      p <- p + facet_wrap(~ ind, scales=\"free\")\n      p <- p + xlab(\"Standard normal quantiles\") + ylab(\"Random effect quantiles\")\n    } else {  ## caterpillar dotplot\n      p <- ggplot(pDf, aes(ID, y)) + coord_flip()\n      if(likeDotplot) {  ## imitate dotplot() -> same scales for random effects\n        p <- p + facet_wrap(~ ind)\n      } else {           ## different scales for random effects\n        p <- p + facet_grid(ind ~ ., scales=\"free_y\")\n      }\n      p <- p + xlab(\"Levels\") + ylab(\"Random effects\")\n    }\n    \n    p <- p + theme(legend.position=\"none\")\n    p <- p + geom_hline(yintercept=0)\n    p <- p + geom_errorbar(aes(ymin=y-ci, ymax=y+ci), width=0, colour=\"black\")\n    p <- p + geom_point(aes(size=1.2), colour=\"blue\") \n    return(p)\n  }\n  \n  lapply(re, f)\n}\n\nwmata <- read.dta('Data/Collapsed_Example_0616_Hiro1.dta')\nwmata <- subset(wmata, log(ridersum) >0)\n\n\nnull_model <- gls( log1p(ridersum) ~ peak_fare_05, data=wmata)\nnull_model_multi_o <- lme( log1p(ridersum) ~ peak_fare_05, random=~1 | mstn_id_o, data=wmata)\n\nanova(null_model, null_model_multi_o)\n\nnull_model_multi_d <- lme( log1p(ridersum) ~ peak_fare_05, random=~1 | mstn_id_d, data=wmata)\n\nanova(null_model_multi_o, null_model_multi_d)\n\nnull_model_od <- lmer( log(ridersum) ~ peak_fare_05 + (1 | mstn_id_d)+ (1 | mstn_id_o) , data=wmata)\n\n\nplot(null_model_od)\ndev.print(png, filename=\"output/nullod_residplot.png\", height=300)\n\nqqnorm(resid(null_model_od))\ndev.print(png, filename=\"output/nullod_qqplot.png\", height=300)\n\ngCaterpillar(ranef(null_model_od, condVar=TRUE))  ## using ggplot2\ndev.print(png, filename=\"output/model1_qq_rand_d.png\", height=300)\n\nhtmlreg(null_model_od, type=\"html\", file=\"output/nullod_results.docx\")\n\ntbl1 = VarCorr(null_model_od)\nclass(tbl1) = \"matrix\"\nprint.xtable(xtable(tbl1), type=\"html\", file=\"output/nullod_rand.docx\")\n\n\n\n\nmodel_1<- lmer( log(ridersum) ~ peak_fare_05 + off_peak_fare_05 + track_mile + comp_mile + travel_time +\n                  (1 | mstn_id_o) + (1 | mstn_id_d),\n                 data = wmata)\n\nmodel_1a<- lmer( log(ridersum) ~ peak_fare_05 + off_peak_fare_05 + track_mile + comp_mile + travel_time +\n                  (1 | mstn_id_d)+ (1 | mstn_id_o),\n                data = wmata)\n\nsummary(model_1)\n\n\nmodel_2<- lmer( log(ridersum) ~ peak_fare_05 + off_peak_fare_05 + track_mile + comp_mile + travel_time + MedianHHIncome_O +\n                  (1 | mstn_id_o) + (1 | mstn_id_d),\n                data = wmata) \n\nmodel_2a<- lmer( log(ridersum) ~ peak_fare_05 + off_peak_fare_05 + track_mile + comp_mile + travel_time + MedianHHIncome_O +\n                  (1 + MedianHHIncome_O| mstn_id_o) + (1 | mstn_id_d),\n                data = wmata) \n\nmodel_3 <- lmer( log(ridersum) ~ log(peak_fare_05) + inv_comp_mile + log_tt_ratio2_fill + tt_ratio201 + log_parking_users + redline_OD + m25_1 + m25_2 + logjobshalfUp_D + log_tphpeakv2_D + log_buslinescount_D + log_ParkingCapacityNew_O + log_hh_o + log_buslinescount_O +\n                   (1 | mstn_id_o) + (1 | mstn_id_d),\n                 data = wmata)\n\n\nmodel_4 <- lmer( log(ridersum) ~ log(peak_fare_05) + log(off_peak_fare_05) + track_mile + inv_comp_mile + log_tt_ratio2_fill + tt_ratio201 + log_parking_users + redline_OD + m25_1 + m25_2 + logjobshalfUp_D + log_tphpeakv2_D + log_buslinescount_D + log_ParkingCapacityNew_O + log_hh_o + log_buslinescount_O +\n                   + log1p(travel_time) + log(MedianHHIncome_O) +\n                   (1 | mstn_id_o) + (1 | mstn_id_d),\n                 data = wmata)\n\n\nmodel_5 <- lmer( log(ridersum) ~ log(peak_fare_05) + log(off_peak_fare_05) + track_mile + inv_comp_mile + log_tt_ratio2_fill + tt_ratio201 + log_parking_users + redline_OD + m25_1 + m25_2 + logjobshalfUp_D + log_tphpeakv2_D + \n                   log_buslinescount_D + log_ParkingCapacityNew_O + log_hh_o + log_buslinescount_O + log1p(travel_time) + \n                   (1 + log_ParkingCapacityNew_O + log_hh_o | mstn_id_o) + (1 +logjobshalfUp_D + log_tphpeakv2_D | mstn_id_d),\n                 data = wmata)\n",
    "created" : 1434556579278.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3968648274",
    "id" : "B31144FA",
    "lastKnownWriteTime" : 1434576691,
    "path" : "~/models/wmata/multilevel_drm.R",
    "project_path" : "multilevel_drm.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}